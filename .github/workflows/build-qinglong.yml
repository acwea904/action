name: é¢„æ„å»ºé’é¾™é¢æ¿

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'é’é¾™ç‰ˆæœ¬ (å¦‚: 2.17.12ï¼Œç•™ç©ºä½¿ç”¨æœ€æ–°)'
        required: false
        default: ''
      node_version:
        description: 'Node.js ç‰ˆæœ¬'
        required: false
        default: '18'

#  schedule:
#    - cron: '0 0 * * 1'

env:
  NODE_OPTIONS: --max-old-space-size=4096

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Qinglong Latest Version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(curl -sL "https://api.github.com/repos/whyour/qinglong/releases/latest" | jq -r '.tag_name' | sed 's/^v//')
            if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
              VERSION="2.17.12"
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ æ„å»ºç‰ˆæœ¬: $VERSION"

      - name: Delete Existing Release
        run: |
          RELEASE_TAG="qinglong-v${{ steps.version.outputs.version }}"
          echo "ğŸ—‘ï¸ æ£€æŸ¥å¹¶åˆ é™¤å·²å­˜åœ¨çš„ Release: $RELEASE_TAG"
          
          # è·å– release id
          RELEASE_ID=$(curl -s \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${RELEASE_TAG}" \
            | jq -r '.id')
          
          if [ "$RELEASE_ID" != "null" ] && [ -n "$RELEASE_ID" ]; then
            echo "åˆ é™¤ Release ID: $RELEASE_ID"
            curl -s -X DELETE \
              -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/${RELEASE_ID}"
            
            # åˆ é™¤ tag
            git push origin --delete "$RELEASE_TAG" 2>/dev/null || true
            echo "âœ“ å·²åˆ é™¤"
          else
            echo "âœ“ ä¸å­˜åœ¨ï¼Œè·³è¿‡"
          fi

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ github.event.inputs.node_version || '18' }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Clone Qinglong
        run: |
          echo "ğŸ“¥ å…‹éš†é’é¾™é¢æ¿ v${{ steps.version.outputs.version }}..."
          git clone --depth 1 --branch "${{ steps.version.outputs.tag }}" \
            https://github.com/whyour/qinglong.git qinglong || \
          git clone --depth 1 https://github.com/whyour/qinglong.git qinglong

      - name: Install Dependencies
        run: |
          cd qinglong
          echo "ğŸ“¦ å®‰è£…ä¾èµ–..."
          npm config set registry https://registry.npmmirror.com
          pnpm config set registry https://registry.npmmirror.com
          pnpm install

      - name: Build Backend
        run: |
          cd qinglong
          echo "ğŸ”¨ æ„å»ºåç«¯..."
          pnpm run build:back || true
          [ -f "build/app.js" ] && echo "âœ“ åç«¯æ„å»ºæˆåŠŸ" || echo "âš ï¸ åç«¯æœªæ„å»º"

      - name: Build Frontend
        run: |
          cd qinglong
          echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
          pnpm run build:front || true
          [ -d "static/dist" ] && echo "âœ“ å‰ç«¯æ„å»ºæˆåŠŸ" || echo "âš ï¸ å‰ç«¯æœªæ„å»º"

      - name: Prepare Production Package
        run: |
          cd qinglong
          echo "ğŸ“¦ å‡†å¤‡ç”Ÿäº§åŒ…..."
          
          # é‡æ–°å®‰è£…ç”Ÿäº§ä¾èµ–
          rm -rf node_modules
          pnpm install --prod
          
          # æ¸…ç†
          rm -rf .git .github .vscode .idea
          rm -rf .eslintrc* .prettierrc* .prettierignore
          rm -rf tsconfig*.json .umirc.ts .umirc.js
          rm -rf *.md .env* .editorconfig .gitignore .npmrc
          rm -rf test tests __tests__ coverage
          rm -rf Dockerfile* docker-compose* .dockerignore
          rm -rf nodemon.json typings.d.ts
          rm -rf pnpm-lock.yaml package-lock.json yarn.lock
          
          [ -f "build/app.js" ] && rm -rf back/
          [ -d "static/dist" ] && rm -rf src/
          
          # æ¸…ç† node_modules
          find node_modules -name "*.md" -type f -delete 2>/dev/null || true
          find node_modules -type d -name "test" -exec rm -rf {} + 2>/dev/null || true
          find node_modules -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true
          find node_modules -type d -name "__tests__" -exec rm -rf {} + 2>/dev/null || true
          find node_modules -type d -name "example" -exec rm -rf {} + 2>/dev/null || true
          find node_modules -type d -name "examples" -exec rm -rf {} + 2>/dev/null || true
          find node_modules -type d -name "docs" -exec rm -rf {} + 2>/dev/null || true
          
          echo "âœ“ æ¸…ç†å®Œæˆ"
          echo "ğŸ“Š å¤§å°: $(du -sh . | cut -f1)"

      - name: Create Startup Script
        run: |
          cd qinglong
          cat > start.sh << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          export QlPort=${QlPort:-5700}
          echo "ğŸ‰ å¯åŠ¨é’é¾™é¢æ¿ (ç«¯å£: $QlPort)"
          exec node build/app.js
          EOF
          chmod +x start.sh

      - name: Create VERSION.json
        run: |
          cd qinglong
          cat > VERSION.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "node": "$(node -v)",
            "buildTime": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF

      - name: Package Files
        id: package
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          NODE_VER="${{ github.event.inputs.node_version || '18' }}"
          PACKAGE_NAME="qinglong-v${VERSION}-node${NODE_VER}-packed"
          
          echo "ğŸ“¦ åˆ›å»ºå‹ç¼©åŒ…..."
          
          # åˆ›å»º tar.gz
          tar -czf "${PACKAGE_NAME}.tar.gz" qinglong
          TAR_SIZE=$(ls -lh "${PACKAGE_NAME}.tar.gz" | awk '{print $5}')
          echo "âœ“ ${PACKAGE_NAME}.tar.gz ($TAR_SIZE)"
          
          # åˆ›å»º zip
          zip -r -q "${PACKAGE_NAME}.zip" qinglong
          ZIP_SIZE=$(ls -lh "${PACKAGE_NAME}.zip" | awk '{print $5}')
          echo "âœ“ ${PACKAGE_NAME}.zip ($ZIP_SIZE)"
          
          # åˆ›å»ºæ ¡éªŒå’Œ
          sha256sum "${PACKAGE_NAME}.tar.gz" > checksums.txt
          sha256sum "${PACKAGE_NAME}.zip" >> checksums.txt
          echo ""
          echo "ğŸ” SHA256:"
          cat checksums.txt
          
          # éªŒè¯æ–‡ä»¶å­˜åœ¨
          echo ""
          echo "ğŸ“ æ‰“åŒ…æ–‡ä»¶åˆ—è¡¨:"
          ls -la *.tar.gz *.zip checksums.txt
          
          # è¾“å‡ºå˜é‡
          echo "package_name=${PACKAGE_NAME}" >> $GITHUB_OUTPUT
          echo "tar_file=${PACKAGE_NAME}.tar.gz" >> $GITHUB_OUTPUT
          echo "zip_file=${PACKAGE_NAME}.zip" >> $GITHUB_OUTPUT

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: qinglong-v${{ steps.version.outputs.version }}
          name: ğŸ‰ Qinglong v${{ steps.version.outputs.version }} (Packed)
          body: |
            ## ğŸ‰ é’é¾™é¢æ¿ v${{ steps.version.outputs.version }} é¢„æ‰“åŒ…ç‰ˆæœ¬
            
            ### ğŸ“¦ åŒ…å«å†…å®¹
            - âœ… é’é¾™é¢æ¿ v${{ steps.version.outputs.version }}
            - âœ… Node.js ${{ github.event.inputs.node_version || '18' }} ç”Ÿäº§ä¾èµ–
            - âœ… å·²æ„å»ºçš„å‰åç«¯æ–‡ä»¶
            - âœ… å¯åŠ¨è„šæœ¬
            
            ### ğŸš€ å¿«é€Ÿä½¿ç”¨
            ```bash
            # ä¸‹è½½è§£å‹
            curl -sL "https://github.com/${{ github.repository }}/releases/download/qinglong-v${{ steps.version.outputs.version }}/${{ steps.package.outputs.tar_file }}" | tar -xz
            
            # å¯åŠ¨
            cd qinglong
            ./start.sh
            
            # è®¿é—®: http://localhost:5700
