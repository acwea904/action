name: é¢„æ„å»ºé’é¾™é¢æ¿

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'é’é¾™ç‰ˆæœ¬ (å¦‚: 2.17.12ï¼Œç•™ç©ºä½¿ç”¨æœ€æ–°)'
        required: false
        default: ''
      node_version:
        description: 'Node.js ç‰ˆæœ¬'
        required: false
        default: '18'

#  schedule:
#    - cron: '0 0 * * 1'

env:
  NODE_OPTIONS: --max-old-space-size=4096

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Qinglong Latest Version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(curl -sL "https://api.github.com/repos/whyour/qinglong/releases/latest" | jq -r '.tag_name' | sed 's/^v//')
            if [ -z "$VERSION" ] || [ "$VERSION" = "null" ]; then
              VERSION="2.17.12"
            fi
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "tag=v$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ æ„å»ºç‰ˆæœ¬: $VERSION"

      - name: Check if Release Exists
        id: check_release
        run: |
          RELEASE_TAG="qinglong-v${{ steps.version.outputs.version }}"
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${RELEASE_TAG}")
          
          if [ "$HTTP_CODE" = "200" ]; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Release $RELEASE_TAG å·²å­˜åœ¨"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
            echo "âœ“ å°†åˆ›å»ºæ–° Release: $RELEASE_TAG"
          fi

      - name: Setup Node.js
        if: steps.check_release.outputs.exists != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: ${{ github.event.inputs.node_version || '18' }}

      - name: Setup pnpm
        if: steps.check_release.outputs.exists != 'true'
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Clone Qinglong
        if: steps.check_release.outputs.exists != 'true'
        run: |
          echo "ğŸ“¥ å…‹éš†é’é¾™é¢æ¿ v${{ steps.version.outputs.version }}..."
          
          git clone --depth 1 --branch "${{ steps.version.outputs.tag }}" \
            https://github.com/whyour/qinglong.git qinglong || \
          git clone --depth 1 https://github.com/whyour/qinglong.git qinglong
          
          cd qinglong
          echo "âœ“ å…‹éš†å®Œæˆ"
          
          # æ˜¾ç¤º package.json ä¸­çš„ scripts
          echo ""
          echo "ğŸ“œ å¯ç”¨çš„æ„å»ºè„šæœ¬:"
          cat package.json | jq -r '.scripts | to_entries[] | "  \(.key): \(.value)"'

      - name: Install All Dependencies
        if: steps.check_release.outputs.exists != 'true'
        run: |
          cd qinglong
          echo "ğŸ“¦ å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆåŒ…æ‹¬å¼€å‘ä¾èµ–ï¼‰..."
          
          npm config set registry https://registry.npmmirror.com
          pnpm config set registry https://registry.npmmirror.com
          
          # å®‰è£…æ‰€æœ‰ä¾èµ–ï¼ˆéœ€è¦å¼€å‘ä¾èµ–æ¥æ„å»ºï¼‰
          pnpm install
          
          echo "âœ“ ä¾èµ–å®‰è£…å®Œæˆ"
          echo ""
          echo "ğŸ“Š node_modules å¤§å°:"
          du -sh node_modules

      - name: Build Backend
        if: steps.check_release.outputs.exists != 'true'
        run: |
          cd qinglong
          echo "ğŸ”¨ æ„å»ºåç«¯..."
          
          # æ£€æŸ¥å¹¶æ‰§è¡Œåç«¯æ„å»º
          if grep -q '"build:back"' package.json; then
            pnpm run build:back
            echo "âœ“ åç«¯æ„å»ºå®Œæˆ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° build:back è„šæœ¬"
          fi
          
          # æ£€æŸ¥æ„å»ºç»“æœ
          if [ -d "build" ]; then
            echo "ğŸ“ build/ ç›®å½•å†…å®¹:"
            ls -la build/
          fi

      - name: Build Frontend
        if: steps.check_release.outputs.exists != 'true'
        run: |
          cd qinglong
          echo "ğŸ”¨ æ„å»ºå‰ç«¯..."
          
          # æ£€æŸ¥å¹¶æ‰§è¡Œå‰ç«¯æ„å»º
          if grep -q '"build:front"' package.json; then
            pnpm run build:front
            echo "âœ“ å‰ç«¯æ„å»ºå®Œæˆ"
          else
            echo "âš ï¸ æœªæ‰¾åˆ° build:front è„šæœ¬ï¼Œå°è¯•å…¶ä»–æ–¹å¼..."
            
            # å°è¯•ä½¿ç”¨ umi æ„å»º
            if [ -f ".umirc.ts" ] || [ -f ".umirc.js" ]; then
              echo "æ£€æµ‹åˆ° UmiJS é…ç½®ï¼Œå°è¯•æ„å»º..."
              npx umi build || pnpm umi build || true
            fi
          fi
          
          # æ£€æŸ¥å‰ç«¯æ„å»ºç»“æœ
          echo ""
          echo "ğŸ“ æ£€æŸ¥æ„å»ºäº§ç‰©:"
          [ -d "dist" ] && echo "dist/ å­˜åœ¨:" && ls -la dist/ | head -10
          [ -d "static/dist" ] && echo "static/dist/ å­˜åœ¨:" && ls -la static/dist/ | head -10
          [ -d "build/public" ] && echo "build/public/ å­˜åœ¨:" && ls -la build/public/ | head -10

      - name: Verify Build
        if: steps.check_release.outputs.exists != 'true'
        run: |
          cd qinglong
          echo "ğŸ” éªŒè¯æ„å»ºç»“æœ..."
          
          # æ£€æŸ¥åç«¯æ„å»º
          if [ -f "build/app.js" ]; then
            echo "âœ“ åç«¯æ„å»ºæˆåŠŸ: build/app.js"
          elif [ -d "back" ]; then
            echo "âš ï¸ åç«¯æœªæ„å»ºï¼Œå°†ä½¿ç”¨æºæ–‡ä»¶"
          fi
          
          # æ£€æŸ¥å‰ç«¯æ„å»º
          if [ -d "static/dist" ] && [ -f "static/dist/index.html" ]; then
            echo "âœ“ å‰ç«¯æ„å»ºæˆåŠŸ: static/dist/"
          elif [ -d "dist" ] && [ -f "dist/index.html" ]; then
            echo "âœ“ å‰ç«¯æ„å»ºæˆåŠŸ: dist/"
            # ç§»åŠ¨åˆ°æ­£ç¡®ä½ç½®
            mkdir -p static
            mv dist static/dist
          else
            echo "âš ï¸ å‰ç«¯æœªæ„å»º"
          fi
          
          echo ""
          echo "ğŸ“ å½“å‰ç›®å½•ç»“æ„:"
          ls -la
          [ -d "build" ] && echo "" && echo "build/:" && ls -la build/
          [ -d "static" ] && echo "" && echo "static/:" && ls -la static/

      - name: Prepare Production Package
        if: steps.check_release.outputs.exists != 'true'
        run: |
          cd qinglong
          echo "ğŸ“¦ å‡†å¤‡ç”Ÿäº§åŒ…..."
          
          # åˆ é™¤ node_modulesï¼Œé‡æ–°å®‰è£…ç”Ÿäº§ä¾èµ–
          rm -rf node_modules
          
          echo "ğŸ“¦ å®‰è£…ç”Ÿäº§ä¾èµ–..."
          pnpm install --prod
          
          # æ¸…ç†ä¸éœ€è¦çš„æ–‡ä»¶å’Œç›®å½•
          echo "ğŸ§¹ æ¸…ç†æ–‡ä»¶..."
          
          # åˆ é™¤å¼€å‘ç›¸å…³æ–‡ä»¶
          rm -rf .git .github .vscode .idea
          rm -rf .eslintrc* .prettierrc* .prettierignore
          rm -rf tsconfig*.json .umirc.ts .umirc.js
          rm -rf *.md .env* .editorconfig .gitignore .npmrc
          rm -rf test tests __tests__ coverage
          rm -rf Dockerfile* docker-compose* .dockerignore
          rm -rf nodemon.json typings.d.ts
          rm -rf pnpm-lock.yaml package-lock.json yarn.lock
          
          # å¦‚æœåç«¯å·²æ„å»ºï¼Œåˆ é™¤æºæ–‡ä»¶
          if [ -f "build/app.js" ]; then
            echo "åˆ é™¤åç«¯æºæ–‡ä»¶..."
            rm -rf back/
          fi
          
          # å¦‚æœå‰ç«¯å·²æ„å»ºï¼Œåˆ é™¤æºæ–‡ä»¶
          if [ -d "static/dist" ] && [ -f "static/dist/index.html" ]; then
            echo "åˆ é™¤å‰ç«¯æºæ–‡ä»¶..."
            rm -rf src/
          fi
          
          # æ¸…ç† node_modules
          echo "æ¸…ç† node_modules..."
          find node_modules -name "*.md" -delete 2>/dev/null || true
          find node_modules -name "*.ts" -not -name "*.d.ts" -delete 2>/dev/null || true
          find node_modules -name "test" -type d -exec rm -rf {} + 2>/dev/null || true
          find node_modules -name "tests" -type d -exec rm -rf {} + 2>/dev/null || true
          find node_modules -name "__tests__" -type d -exec rm -rf {} + 2>/dev/null || true
          find node_modules -name "example" -type d -exec rm -rf {} + 2>/dev/null || true
          find node_modules -name "examples" -type d -exec rm -rf {} + 2>/dev/null || true
          find node_modules -name ".github" -type d -exec rm -rf {} + 2>/dev/null || true
          find node_modules -name "docs" -type d -exec rm -rf {} + 2>/dev/null || true
          find node_modules -name "*.map" -delete 2>/dev/null || true
          
          echo "âœ“ æ¸…ç†å®Œæˆ"
          
          # æ˜¾ç¤ºæœ€ç»ˆç»“æœ
          echo ""
          echo "ğŸ“Š æœ€ç»ˆåŒ…å¤§å°:"
          du -sh .
          du -sh node_modules
          [ -d "build" ] && du -sh build
          [ -d "static" ] && du -sh static
          
          echo ""
          echo "ğŸ“ æœ€ç»ˆç›®å½•ç»“æ„:"
          ls -la
          
          echo ""
          echo "ğŸ“ é‡è¦ç›®å½•å†…å®¹:"
          [ -d "build" ] && echo "build/:" && ls -la build/
          [ -d "static" ] && echo "static/:" && ls -la static/
          [ -d "shell" ] && echo "shell/:" && ls -la shell/

      - name: Create Version Info
        if: steps.check_release.outputs.exists != 'true'
        run: |
          cd qinglong
          cat > VERSION.json << EOF
          {
            "version": "${{ steps.version.outputs.version }}",
            "node": "$(node -v)",
            "pnpm": "$(pnpm -v)",
            "buildTime": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
            "buildBy": "GitHub Actions",
            "repository": "${{ github.repository }}",
            "hasBuild": $([ -f "build/app.js" ] && echo "true" || echo "false"),
            "hasFrontend": $([ -d "static/dist" ] && echo "true" || echo "false")
          }
          EOF
          echo "ğŸ“„ VERSION.json:"
          cat VERSION.json

      - name: Create Startup Script
        if: steps.check_release.outputs.exists != 'true'
        run: |
          cd qinglong
          
          # åˆ›å»ºå¯åŠ¨è„šæœ¬
          cat > start.sh << 'EOF'
          #!/bin/bash
          
          # é’é¾™é¢æ¿å¯åŠ¨è„šæœ¬
          cd "$(dirname "$0")"
          
          # é»˜è®¤ç«¯å£
          export QlPort=${QlPort:-5700}
          export QlBaseUrl=${QlBaseUrl:-/}
          
          echo "ğŸ‰ å¯åŠ¨é’é¾™é¢æ¿..."
          echo "   ç«¯å£: $QlPort"
          echo "   è·¯å¾„: $QlBaseUrl"
          
          # æ£€æŸ¥å¯åŠ¨æ–¹å¼
          if [ -f "build/app.js" ]; then
            echo "   æ¨¡å¼: å·²æ„å»º"
            exec node build/app.js
          elif [ -f "back/app.ts" ]; then
            echo "   æ¨¡å¼: æºç  (éœ€è¦ ts-node)"
            exec npx ts-node back/app.ts
          else
            echo "âŒ æœªæ‰¾åˆ°å…¥å£æ–‡ä»¶"
            exit 1
          fi
          EOF
          
          chmod +x start.sh
          echo "âœ“ åˆ›å»ºå¯åŠ¨è„šæœ¬: start.sh"

      - name: Package - tar.gz
        if: steps.check_release.outputs.exists != 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          NODE_VER="${{ github.event.inputs.node_version || '18' }}"
          PACKAGE_NAME="qinglong-v${VERSION}-node${NODE_VER}-packed"
          
          echo "ğŸ“¦ åˆ›å»º ${PACKAGE_NAME}.tar.gz..."
          tar -czf "${PACKAGE_NAME}.tar.gz" qinglong
          
          ls -lh "${PACKAGE_NAME}.tar.gz"
          
          SHA256=$(sha256sum "${PACKAGE_NAME}.tar.gz" | cut -d' ' -f1)
          echo "SHA256: $SHA256"
          
          echo "PACKAGE_NAME=${PACKAGE_NAME}" >> $GITHUB_ENV
          echo "PACKAGE_SHA256=${SHA256}" >> $GITHUB_ENV

      - name: Package - zip
        if: steps.check_release.outputs.exists != 'true'
        run: |
          echo "ğŸ“¦ åˆ›å»º ${{ env.PACKAGE_NAME }}.zip..."
          zip -r -q "${{ env.PACKAGE_NAME }}.zip" qinglong
          ls -lh "${{ env.PACKAGE_NAME }}.zip"

      - name: Generate Checksums
        if: steps.check_release.outputs.exists != 'true'
        run: |
          sha256sum ${{ env.PACKAGE_NAME }}.tar.gz > checksums.txt
          sha256sum ${{ env.PACKAGE_NAME }}.zip >> checksums.txt
          cat checksums.txt

      - name: Create Release
        if: steps.check_release.outputs.exists != 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: qinglong-v${{ steps.version.outputs.version }}
          name: ğŸ‰ Qinglong v${{ steps.version.outputs.version }} (Packed)
          body: |
            ## ğŸ‰ é’é¾™é¢æ¿ v${{ steps.version.outputs.version }} é¢„æ‰“åŒ…ç‰ˆæœ¬
            
            ### ğŸ“¦ åŒ…å«å†…å®¹
            - âœ… é’é¾™é¢æ¿ v${{ steps.version.outputs.version }}
            - âœ… Node.js ${{ github.event.inputs.node_version || '18' }} ç”Ÿäº§ä¾èµ–
            - âœ… å·²æ„å»ºçš„å‰åç«¯æ–‡ä»¶
            - âœ… å¯åŠ¨è„šæœ¬ (start.sh)
            
            ### ğŸš€ å¿«é€Ÿä½¿ç”¨
            
            **1. ä¸‹è½½å¹¶è§£å‹ï¼š**
            ```bash
            curl -sL "https://github.com/${{ github.repository }}/releases/download/qinglong-v${{ steps.version.outputs.version }}/${{ env.PACKAGE_NAME }}.tar.gz" | tar -xz
            cd qinglong
