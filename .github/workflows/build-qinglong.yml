name: é¢„æ„å»ºé’é¾™é¢æ¿

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'é’é¾™ç‰ˆæœ¬ (ç•™ç©ºä½¿ç”¨æœ€æ–°)'
        required: false
        default: ''

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get Version
        id: version
        run: |
          if [ -n "${{ github.event.inputs.version }}" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=$(curl -sL "https://api.github.com/repos/whyour/qinglong/releases/latest" | jq -r '.tag_name' | sed 's/^v//')
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "ğŸ“¦ ç‰ˆæœ¬: $VERSION"

      - name: Check Release
        id: check
        run: |
          if gh release view "qinglong-v${{ steps.version.outputs.version }}" &>/dev/null; then
            echo "exists=true" >> $GITHUB_OUTPUT
            echo "âš ï¸ Release å·²å­˜åœ¨"
          else
            echo "exists=false" >> $GITHUB_OUTPUT
          fi
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        if: steps.check.outputs.exists != 'true'
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Setup pnpm
        if: steps.check.outputs.exists != 'true'
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Clone and Build
        if: steps.check.outputs.exists != 'true'
        run: |
          git clone --depth 1 --branch "v${{ steps.version.outputs.version }}" \
            https://github.com/whyour/qinglong.git qinglong
          
          cd qinglong
          pnpm install
          pnpm run build:back
          pnpm run build:front
          
          rm -rf node_modules
          pnpm install --prod
          
          rm -rf .git .github src/ back/ *.md
          
          cat > start.sh << 'EOF'
          #!/bin/bash
          cd "$(dirname "$0")"
          export QlPort=${QlPort:-5700}
          echo "ğŸ‰ å¯åŠ¨é’é¾™é¢æ¿ (ç«¯å£: $QlPort)"
          exec node build/app.js
          EOF
          chmod +x start.sh

      - name: Package
        if: steps.check.outputs.exists != 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          NAME="qinglong-v${VERSION}-node18-packed"
          
          tar -czf "${NAME}.tar.gz" qinglong
          zip -r -q "${NAME}.zip" qinglong
          sha256sum ${NAME}.* > checksums.txt
          
          ls -lh ${NAME}.*

      - name: Upload Release
        if: steps.check.outputs.exists != 'true'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          TAG="qinglong-v${VERSION}"
          NAME="qinglong-v${VERSION}-node18-packed"
          
          gh release create "$TAG" \
            --title "ğŸ‰ Qinglong v${VERSION} (Packed)" \
            --notes "## é’é¾™é¢æ¿ v${VERSION} é¢„æ‰“åŒ…ç‰ˆ

          ### å¿«é€Ÿä½¿ç”¨
          \`\`\`bash
          curl -sL https://github.com/${{ github.repository }}/releases/download/${TAG}/${NAME}.tar.gz | tar -xz
          cd qinglong && ./start.sh
          \`\`\`
          
          è®¿é—®: http://localhost:5700" \
            "${NAME}.tar.gz" \
            "${NAME}.zip" \
            "checksums.txt"
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
