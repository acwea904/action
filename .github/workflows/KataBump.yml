name: KataBump è‡ªåŠ¨ç»­è®¢

on:
  schedule:
    - cron: '0 8 * * *'
  workflow_dispatch:
    inputs:
      force_renew:
        description: 'å¼ºåˆ¶ç»­è®¢'
        required: false
        default: 'false'
        type: boolean

jobs:
  renew:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: å®‰è£…ä¾èµ–
        run: |
          pip install playwright pynacl
          playwright install chromium

      - name: ä¸‹è½½ Hysteria2
        run: |
          wget -q https://github.com/apernet/hysteria/releases/latest/download/hysteria-linux-amd64 -O hysteria
          chmod +x hysteria

      - name: é…ç½® Hysteria2
        env:
          HY2_URL: ${{ secrets.HY2_URL }}
        run: |
          # é²æ£’çš„ URL è§£æé€»è¾‘
          URL_BODY="${HY2_URL#hysteria2://}"
          URL_BODY="${URL_BODY%%#*}"
          PASSWORD="${URL_BODY%%@*}"
          SERVER_PART="${URL_BODY#*@}"
          SERVER="${SERVER_PART%%\?*}"
          PARAMS="${SERVER_PART#*\?}"
          
          get_param() { echo "$PARAMS" | tr '&' '\n' | grep "^$1=" | cut -d'=' -f2; }
          
          SNI=$(get_param "sni")
          INSECURE=$(get_param "insecure")
          [ -z "$SNI" ] && SNI="${SERVER%%:*}"
          [ "$INSECURE" = "1" ] && INSECURE="true" || INSECURE="false"
          
          cat > hy2-config.yaml << EOF
server: ${SERVER}
auth: ${PASSWORD}
tls:
  sni: ${SNI}
  insecure: ${INSECURE}
http:
  listen: 127.0.0.1:8080
EOF

      - name: å¯åŠ¨å¹¶æ ¡éªŒä»£ç†
        run: |
          # å¯åŠ¨ä»£ç†å¹¶å°†æ—¥å¿—è®°å½•åˆ°æ–‡ä»¶
          ./hysteria client -c hy2-config.yaml > hy2.log 2>&1 &
          
          echo "â³ ç­‰å¾…ä»£ç†åˆå§‹åŒ–..."
          sleep 8
          
          # 1. æ£€æŸ¥è¿›ç¨‹
          if ! ps aux | grep -v grep | grep "hysteria" > /dev/null; then
            echo "âŒ Hysteria è¿›ç¨‹æœªèƒ½å¯åŠ¨ï¼Œæ—¥å¿—ï¼š"
            cat hy2.log
            exit 1
          fi
          
          # 2. æ£€æŸ¥ç½‘ç»œè¿é€šæ€§ (æµ‹è¯•è®¿é—®ç›®æ ‡ç½‘ç«™)
          echo "ğŸŒ æµ‹è¯•ä»£ç†è¿é€šæ€§..."
          if curl -x http://127.0.0.1:8080 -I https://dashboard.katabump.com --connect-timeout 10 > /dev/null 2>&1; then
            echo "âœ… ä»£ç†è¿æ¥æˆåŠŸï¼"
          else
            echo "âŒ ä»£ç†æ— æ³•è®¿é—®ç›®æ ‡ç½‘ç«™ï¼Œè¯·æ£€æŸ¥èŠ‚ç‚¹å¯ç”¨æ€§æˆ–æœåŠ¡å™¨é˜²ç«å¢™"
            cat hy2.log
            exit 1
          fi

      - name: è¿è¡Œç»­è®¢
        env:
          KATA_USERNAME: ${{ secrets.KATA_EMAIL }}
          KATA_PASSWORD: ${{ secrets.KATA_PASSWORD }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          PROXY_SERVER: "http://127.0.0.1:8080"
          FORCE_RENEW: ${{ github.event.inputs.force_renew || 'false' }}
        run: python scripts/katabump_renew.py

      - name: ä¸Šä¼ è°ƒè¯•ä¿¡æ¯
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: debug-info
          path: |
            *.png
            hy2.log
          retention-days: 3
